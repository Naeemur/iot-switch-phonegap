<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="theme-color" content="#F9BF3B">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<title>Light Switch</title>
  <link rel="stylesheet" href="index.css">
</head>
<body>
<script>var LIGHT = false;</script>
<!--<h1>Light Switch</h1>-->
<input type="checkbox" id="chek">

<div id="bar">
	<div class="main-bar">
		<div id="back">
			<svg file="arrow-linear-left.svg" class="ic" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
				<polygon points="9.19 1.64 7.78 0.22 1.41 6.59 1.41 6.59 0 8 1.41 9.41 1.41 9.41 7.78 15.78 9.19 14.36 3.83 9 16 9 16 7 3.83 7 9.19 1.64"/>
			</svg>
		</div>
		<div class="text">IoT Light Switch</div>
	</div>
	<div class="setting-bar">
		<div class="text">Settings</div>
	</div>
</div>

<form id="form" action="/user" method="POST">
	<p>Username</p>
	<input id="user" type="text" name="user" placeholder="Username">
	<p>Password</p>
	<input id="pass" type="password" name="pass" placeholder="Password"><br>
	<input id="bttn" type="submit" value="SAVE">
</form>

<div id="bulb">
	<svg id="light-base" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 400">
	<title>Light-Bulb</title>
	<g>
		<path d="M97.52,320.55h105a5,5,0,0,0,0-10h-105a5,5,0,0,0,0,10Z"/>
		<path d="M207.29,328H92.71a5,5,0,1,0,0,10H207.29a5,5,0,1,0,0-10Z"/>
		<path d="M202.48,345.92h-105a5,5,0,0,0,0,10h105a5,5,0,0,0,0-10Z"/>
		<path d="M187.89,363.48H112.11a5,5,0,1,0,0,10h75.79a5,5,0,0,0,0-10Z"/>
	</g>
	</svg>

	<svg id="light-glass" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 400">
	<title>Light-Bulb</title>
	<path d="M150,80.63a96,96,0,0,0-39.16,183.65v38.88h78.32V264.28A96,96,0,0,0,150,80.63Zm15.84,119.26a19.08,19.08,0,0,1-8.19-1.86,29.16,29.16,0,0,0,0-34.75,19.22,19.22,0,1,1,8.19,36.6Zm-12.45-19.23A19.11,19.11,0,0,1,150,191.55a19.15,19.15,0,0,1,0-21.76A19.11,19.11,0,0,1,153.39,180.66Zm-11,17.37a19.23,19.23,0,1,1,0-34.75,29.16,29.16,0,0,0,0,34.75Zm-3.19,11.42A29,29,0,0,0,150,205.21a29,29,0,0,0,10.84,4.25v83.69H139.16Zm43.12,46.88-3.12,1.27v35.55h-8.32V209.46A29.22,29.22,0,1,0,150,156.12a29.22,29.22,0,1,0-20.84,53.34v83.69h-8.32V257.6l-3.12-1.27a86,86,0,1,1,64.57,0Z"/>
	</svg>

	<svg id="light-ray" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 400">
	<title>Light-Bulb</title>
	<g>
		<rect x="57.25" y="67.87" width="10" height="42" transform="translate(-44.61 70.05) rotate(-45)"/>
		<rect x="232.75" y="243.37" width="10" height="42" transform="translate(-117.3 245.55) rotate(-45)"/>
		<rect x="145" y="31.52" width="10" height="42.01"/>
		<rect x="216.75" y="83.87" width="42" height="10" transform="translate(6.79 194.14) rotate(-45)"/>
		<rect x="41.25" y="259.37" width="42" height="10" transform="translate(-168.72 121.47) rotate(-45)"/>
		<rect x="253.09" y="171.62" width="42.01" height="10"/>
		<rect x="4.9" y="171.62" width="42.01" height="10"/>
	</g>
	</svg>
</div>
<div id="bg"></div>

<label id="down" for="chek" title="Show login Setting">
	<svg file="gear.svg" class="ic" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
		<path d="M1,7.23V8.83l1.94.64.45,1.09-.88,1.84,1.13,1.13,1.81-.91,1.09.45L7.23,15H8.82L9.45,13l1.11-.45,1.84.88,1.13-1.13-.92-1.81.47-1.09L15,8.76V7.17l-1.94-.64-.45-1.09.88-1.84L12.36,2.47l-1.81.91L9.46,2.93,8.77,1H7.17L6.54,3,5.43,3.4,3.59,2.52,2.46,3.65l.91,1.81L2.92,6.55ZM8,5A3,3,0,1,1,5,8,3,3,0,0,1,8,5Z"/>
	</svg>
	<svg file="cross.svg" class="ic" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
		<polygon points="12.95 1.64 8 6.59 3.05 1.64 1.64 3.05 6.59 8 1.64 12.95 3.05 14.36 8 9.41 12.95 14.36 14.36 12.95 9.41 8 14.36 3.05 12.95 1.64"/>
	</svg>
</label>

<script src="cordova.js"></script>
<script>
	var host = 'https://iot-switch.herokuapp.com';
	var D = document;
	var I = document.getElementById.bind(document);
	var Q = document.querySelector.bind(document);
	var C = document.createElement.bind(document);
	var addClass = function(el, className) {
		if (el.classList)
			el.classList.add(className);
		else
			el.className += ' ' + className;
	}
	var remClass = function(el, className) {
		if (el.classList)
			el.classList.remove(className);
		else
			el.className = el.className.replace(new RegExp('(^|\\b)' + className.split(' ').join('|') + '(\\b|$)', 'gi'), ' ');
	}
	var LS = window.localStorage || {};
	if(LIGHT) addClass(I('bulb'), 'on');
	I('user').value = LS.user || '';
	I('pass').value = LS.pass || '';
	I('bulb').addEventListener('click', function(e) {
		// alert('light');
		LS.user = I('user').value;
		LS.pass = I('pass').value;
		// do XHR
		var request = new XMLHttpRequest();
		request.open('POST', host+'/user', true);
		request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
		request.onload = function() {
			if (request.status >= 200 && request.status < 400) {
				// Success!
				var res = request.responseText;
				console.log(res);
				if(res == '<h1>Switched on!</h1>') {
					addClass(I('bulb'), 'on');
				} else if(res == '<h1>Switched off!</h1>') {
					remClass(I('bulb'), 'on');
				} else {
					alert('Wrong Username and/or Password!\nEnter correct info and try again.')
				}
			} else {
				// We reached our target server, but it returned an error
			}
		};
		request.onerror = function() {
			// There was a connection error of some sort
			alert('Connection Error! Try again later.');
		};
		request.send("user="+encodeURI(LS.user)+"&pass="+encodeURI(LS.pass));
	});
	I('form').addEventListener('submit', function(e) {
		e.preventDefault();
		I('chek').checked = false;
		LS.user = I('user').value;
		LS.pass = I('pass').value;
	});
	var check = new XMLHttpRequest();
	check.open('GET', host+'/status', true);
	check.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
	check.onload = function() {
		if (check.status >= 200 && check.status < 400) {
			// Success!
			var stat = JSON.parse(check.responseText)['light'];
			console.log(stat);
			if(stat == 'on') {
				addClass(I('bulb'), 'on');
			} else {
				remClass(I('bulb'), 'on');
			}
		} else {
			// We reached our target server, but it returned an error
		}
	};
	check.onerror = function() {
		// There was a connection error of some sort
		// alert('Connection Error! Try again later.');
	};
	setInterval(function(){
		check.open('GET', host+'/status', true);
		check.send();
	},1500);
	// Wait for PhoneGap to load
	function onDeviceReady() {
		// alert("deviceready");
		document.getElementById('back').addEventListener('click', function() {
			navigator.app.exitApp();
		});
	}
	document.addEventListener("deviceready", onDeviceReady, false);
</script>
</body>
</html>
